"use strict";var App=App||{},google=google;App.init=function(){this.apiUrl="http://localhost:3000/api",this.$main=$("main"),$(".register").on("click",this.register.bind(this)),$(".login").on("click",this.login.bind(this)),$(".logout").on("click",this.logout.bind(this)),$(".home").on("click",this.homepage.bind(this)),this.$main.on("submit","form",this.handleForm),this.getToken()?this.loggedInState():this.loggedOutState()},App.createMap=function(){var e=document.getElementById("canvas"),t={zoom:10,center:new google.maps.LatLng(51.49786,(-.137855)),mapTypeId:google.maps.MapTypeId.ROADMAP,styles:[{featureType:"all",elementType:"labels.text.fill",stylers:[{color:"#ffffff"}]},{featureType:"all",elementType:"labels.text.stroke",stylers:[{color:"#000000"},{lightness:13}]},{featureType:"administrative",elementType:"geometry.fill",stylers:[{color:"#000000"}]},{featureType:"administrative",elementType:"geometry.stroke",stylers:[{color:"#144b53"},{lightness:14},{weight:1.4}]},{featureType:"landscape",elementType:"all",stylers:[{color:"#10171f"},{visibility:"on"}]},{featureType:"landscape.man_made",elementType:"all",stylers:[{visibility:"on"}]},{featureType:"landscape.natural",elementType:"all",stylers:[{visibility:"on"}]},{featureType:"landscape.natural.landcover",elementType:"all",stylers:[{visibility:"on"}]},{featureType:"landscape.natural.terrain",elementType:"all",stylers:[{visibility:"on"},{lightness:"0"}]},{featureType:"poi",elementType:"all",stylers:[{hue:"#ff00de"},{visibility:"on"}]},{featureType:"poi",elementType:"geometry",stylers:[{lightness:5}]},{featureType:"poi",elementType:"labels",stylers:[{weight:"0.01"},{lightness:"0"},{visibility:"on"}]},{featureType:"poi",elementType:"labels.text",stylers:[{visibility:"on"}]},{featureType:"poi",elementType:"labels.text.stroke",stylers:[{visibility:"on"},{color:"#ff0000"}]},{featureType:"poi.attraction",elementType:"all",stylers:[{visibility:"on"}]},{featureType:"poi.business",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"poi.government",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"poi.medical",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"poi.place_of_worship",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"poi.school",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"poi.sports_complex",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"geometry",stylers:[{visibility:"on"}]},{featureType:"road",elementType:"labels.text",stylers:[{visibility:"on"}]},{featureType:"road.highway",elementType:"geometry.fill",stylers:[{color:"#000000"}]},{featureType:"road.highway",elementType:"geometry.stroke",stylers:[{color:"#0b434f"},{lightness:25}]},{featureType:"road.arterial",elementType:"all",stylers:[{color:"#51bfca"}]},{featureType:"road.arterial",elementType:"geometry.fill",stylers:[{color:"#a84c9c"}]},{featureType:"road.arterial",elementType:"geometry.stroke",stylers:[{color:"#0b3d51"},{lightness:16}]},{featureType:"road.local",elementType:"geometry",stylers:[{color:"#51bfca"}]},{featureType:"transit",elementType:"all",stylers:[{color:"#146474"},{visibility:"off"}]},{featureType:"water",elementType:"all",stylers:[{color:"#021019"}]}]};App.map=new google.maps.Map(e,t),this.getCrimes()},App.getCrimes=function(){var e=this;navigator.geolocation.getCurrentPosition(function(t){function o(e,t){"OK"===t&&$.each(e,function(e,t){App.addMarkerForParking(t)})}$.get("https://data.police.uk/api/crimes-street/all-crime?lat="+t.coords.latitude+"&lng="+t.coords.longitude).done(function(t){var o=t.filter(function(e){return"vehicle-crime"===e.category});e.loopThroughArray(o)});var n=new google.maps.LatLng(parseFloat(t.coords.latitude),parseFloat(t.coords.longitude));new google.maps.Marker({position:n,map:App.map,animation:google.maps.Animation.DROP}),new google.maps.Circle({strokeColor:"#42f453",strokeOpacity:.8,strokeWeight:2,fillColor:"#42f453",fillOpacity:.35,map:App.map,radius:1700,center:n});App.map.panTo(n),App.map.setZoom(14);var i=new google.maps.places.PlacesService(App.map),a={location:n,radius:"1600",types:["parking"]};setTimeout(function(){i.nearbySearch(a,o)},2e3)})},App.loopThroughArray=function(e){$.each(e,function(e,t){setTimeout(function(){App.addMarkerForCrime(t)},90*e)})},App.addMarkerForParking=function(e){var t=new google.maps.Marker({position:e.geometry.location,map:App.map,icon:"../images/p.png",animation:google.maps.Animation.DROP});App.addInfoWindowForParking(e,t)},App.addInfoWindowForParking=function(e,t){var o=this;google.maps.event.addListener(t,"click",function(){"undefined"!=typeof o.infoWindow&&o.infoWindow.close();var n=e.rating?e.rating:"Unknown";o.infoWindow=new google.maps.InfoWindow({content:'\n      <div class="info-window2">\n      <h2>Parking</h2>\n      <p>Name: '+e.name+"</p><p>Rating: "+n+"</p>\n      </div>\n      "}),o.infoWindow.open(o.map,t)})},App.addMarkerForCrime=function(e){var t=new google.maps.LatLng(parseFloat(e.location.latitude),parseFloat(e.location.longitude)),o=new google.maps.Marker({position:t,map:App.map,icon:"../images/marker.png",animation:google.maps.Animation.DROP});App.addInfoWindowForCrime(e,o)},App.addInfoWindowForCrime=function(e,t){var o=this;google.maps.event.addListener(t,"click",function(){"undefined"!=typeof o.infoWindow&&o.infoWindow.close(),o.infoWindow=new google.maps.InfoWindow({content:'\n      <div class="info-window">\n      <h2>Crime</h2>\n      <p>Outcome: '+e.outcome_status.category+"</p><p>Where: "+e.location.street.name+"</p><p>When: "+e.month+"</p>\n      </div>"}),o.infoWindow.open(o.map,t)})},App.loggedInState=function(){$(".loggedIn").show(),$(".loggedOut").hide(),this.$main.html('\n    <div id="canvas"></div>\n    '),this.createMap.bind(this)()},App.loggedOutState=function(){$(".loggedIn").hide(),$(".loggedOut").show(),this.register()},App.register=function(e){e&&e.preventDefault(),this.$main.html('\n    <h2 class = "signup">Sign Up</h2>\n    <form method="post" action="/register">\n    <div class="form-group">\n    <input class="form-control" type="text" name="user[username]" placeholder="Username">\n    </div>\n    <div class="form-group">\n    <input class="form-control" type="email" name="user[email]" placeholder="Email">\n    </div>\n    <div class="form-group">\n    <input class="form-control" type="password" name="user[password]" placeholder="Password">\n    </div>\n    <div class="form-group">\n    <input class="form-control" type="password" name="user[passwordConfirmation]" placeholder="Password Confirmation">\n    </div>\n    <input class="btn btn-primary" type="submit" value="Register">\n    </form>\n    ')},App.login=function(e){e.preventDefault(),this.$main.html('\n    <h2 class = "login" >Login</h2>\n    <form method="post" action="/login">\n    <div class="form-group">\n    <input class="form-control" type="email" name="email" placeholder="Email">\n    </div>\n    <div class="form-group">\n    <input class="form-control" type="password" name="password" placeholder="Password">\n    </div>\n    <input class="btn btn-primary" type="submit" value="Login">\n    </form>\n    ')},App.logout=function(e){e.preventDefault(),this.removeToken(),this.loggedOutState()},App.homepage=function(){},App.handleForm=function(e){e.preventDefault();var t=""+App.apiUrl+$(this).attr("action"),o=$(this).attr("method"),n=$(this).serialize();return App.ajaxRequest(t,o,n,function(e){e.token&&App.setToken(e.token),App.loggedInState()})},App.ajaxRequest=function(e,t,o,n){return $.ajax({url:e,method:t,data:o,beforeSend:this.setRequestHeader.bind(this)}).done(n).fail(function(e){console.log(e)})},App.setRequestHeader=function(e){return e.setRequestHeader("Authorization","Bearer "+this.getToken())},App.setToken=function(e){return window.localStorage.setItem("token",e)},App.getToken=function(){return window.localStorage.getItem("token")},App.removeToken=function(){return window.localStorage.clear()},$(App.init.bind(App));